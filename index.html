<!DOCTYPE html>
<html>
<head>
  <title>Your App</title>
  <!-- Firebase App (the core Firebase SDK) -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js"></script>
  <!-- Add Firebase products that you want to use -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js"></script>
</head>
<body>
  <!-- Login UI -->
  <div id="login-div">
    <input type="email" id="email" placeholder="Email">
    <input type="password" id="password" placeholder="Password">
    <button onclick="signUp()">Sign Up</button>
    <button onclick="login()">Login</button>
  </div>

  <!-- Canvas and other elements -->
  <div id="app-div" style="display:none;">
    <div id="canvas-container"></div>
    <button onclick="logout()">Logout</button>
  </div>

  <script>
    // Your Firebase configuration
const firebaseConfig = {
  apiKey: "AIzaSyAprfz20HIJORunNhaAO1bFp9v8zsrTRJw",
  authDomain: "hamham-65479.firebaseapp.com",
  projectId: "hamham-65479",
  storageBucket: "hamham-65479.appspot.com",
  messagingSenderId: "306005522870",
  appId: "1:306005522870:web:575be58c93015845a7a917",
  measurementId: "G-P1ZDF163KF"
};
    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);

    // Initialize Firebase Authentication and Firestore
    const auth = firebase.auth();
    const db = firebase.firestore();

    auth.onAuthStateChanged(user => {
      if (user) {
        document.getElementById('login-div').style.display = 'none';
        document.getElementById('app-div').style.display = 'block';
        loadImagesFromFirebase(user.uid);
      } else {
        document.getElementById('login-div').style.display = 'block';
        document.getElementById('app-div').style.display = 'none';
      }
    });

    function signUp() {
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      auth.createUserWithEmailAndPassword(email, password)
        .then((userCredential) => {
          var user = userCredential.user;
          console.log('User signed up:', user);
        })
        .catch((error) => {
          console.error('Error signing up:', error.code, error.message);
        });
    }

    function login() {
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      auth.signInWithEmailAndPassword(email, password)
        .then((userCredential) => {
          var user = userCredential.user;
          console.log('User logged in:', user);
        })
        .catch((error) => {
          console.error('Error logging in:', error.code, error.message);
        });
    }

    function logout() {
      auth.signOut().then(() => {
        console.log('User logged out');
      }).catch((error) => {
        console.error('Error logging out:', error);
      });
    }

    function saveImagesToFirebase(userId) {
      let imageURLs = [];
      for (let i = 0; i < droppedImages.length; i++) {
        imageURLs.push(droppedImages[i].elt.src);
      }
      db.collection('users').doc(userId).set({
        images: imageURLs
      })
      .then(() => {
        console.log("Images successfully saved!");
      })
      .catch((error) => {
        console.error("Error saving images: ", error);
      });
    }

    function loadImagesFromFirebase(userId) {
      db.collection('users').doc(userId).get()
      .then((doc) => {
        if (doc.exists) {
          let imageURLs = doc.data().images;
          for (let i = 0; i < imageURLs.length; i++) {
            let img = createImg(imageURLs[i], '');
            droppedImages.push(img);
          }
          console.log("Images successfully loaded!");
        } else {
          console.log("No such document!");
        }
      })
      .catch((error) => {
        console.error("Error loading images: ", error);
      });
    }

    // Add save functionality on image drop
    function handleFileSelect(file) {
      if (file.type.match('image.*')) {
        let img = createImg(file.data, '');
        droppedImages.push(img);
        saveImagesToFirebase(auth.currentUser.uid);
      } else {
        alert('이미지 파일을 업로드해주세요.');
      }
    }

    // Your p5.js setup and draw functions
    function setup() {
      let canvas = createCanvas(windowWidth, windowHeight);
      canvas.id('myCanvas');
      canvas.drop(handleFileSelect);
      background(255);
    }

    function draw() {
      for (let i = 0; i < droppedImages.length; i++) {
        let imgSize = min(width, height) / 20;
        if (i === clickedImageIndex) {
          let enlargedSize = 15 * imgSize;
          image(droppedImages[i], width / 2 - enlargedSize / 2, height / 2 - enlargedSize / 2, enlargedSize, enlargedSize);
        } else {
          image(droppedImages[i], 0, i * imgSize, imgSize, imgSize);
        }
      }
    }

    function mouseClicked() {
      for (let i = 0; i < droppedImages.length; i++) {
        let imgSize = min(width, height) / 20;
        let x = 0;
        let y = i * imgSize;
        if (mouseX >= x && mouseX <= x + imgSize && mouseY >= y && mouseY <= y + imgSize) {
          clickedImageIndex = i;
        }
      }
    }
  </script>
</body>
</html>
